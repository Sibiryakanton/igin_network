{% load staticfiles %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Room</title>
    <link rel="stylesheet" type="text/css" href="{% static 'styles.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'style.css' %}" />
    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" />
</head>
<body>
<div style="display: none" type="hidden" id="current_user_id">{{request.user.id}}</div>
<div class="message_counter">
    <h4>Новые сообщения:<span class="message_counter_number" id="message_counter_number"></span></h4>
</div>
{% block content %}
{% endblock %}
</body>
<script>
/* Скрипт взаимодействия с сокетом счетчиков (не то же самое, что в файле script.js) */
    current_user_id = document.getElementById('current_user_id').innerHTML;
    chatlist_socket_url = 'ws://' + window.location.host + '/ws/chats_list/';
    var chatlistSocket = new WebSocket(chatlist_socket_url);
    chatlistSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var message_type = data['message_type'];
        var pathname = document.location.pathname.split('/');
        if (message_type === 'set_sum_counter') {
            var unread_messages_sum = data['unread_messages_sum'];

            var counterElement = document.getElementById('message_counter_number');

            counterElement.innerHTML = unread_messages_sum;
         }
         else if (message_type == 'update_message_status'){
            var author_id = data['author_id'];
            var counterElement = document.getElementById('message_counter_number');
            counterElement.innerHTML = parseInt(counterElement.innerHTML) - 1;
            if (pathname.length == 3){
            var room_id = data['chat_id'];
            var updatedElement = document.getElementsByClassName('chat_counter_' + room_id)[0];
            updatedElement.innerHTML = parseInt(updatedElement.innerHTML) - 1;
            }

         }
         else if (message_type == 'create_message'){
            var counterElement = document.getElementById('message_counter_number');
            counterElement.innerHTML = parseInt(counterElement.innerHTML) + 1;
            var room_id = data['chat_id'];
            if (pathname.length == 3){
                var updatedElement = document.getElementsByClassName('chat_counter_' + room_id)[0];
                updatedElement.innerHTML = parseInt(updatedElement.innerHTML) + 1;
            }


         }
         else if (message_type == 'chat_counter'){
            var room_id = data['chat_id'];
            var unread_messages_sum = data['unread_messages_sum'];
            var updatedElement = document.getElementsByClassName('chat_counter_' + room_id)[0];
            if (updatedElement){
                updatedElement.innerHTML = unread_messages_sum;
            }
         }
    };

    chatlistSocket.onclose = function(e) {
        console.error('Chat socket closed');
    };

</script>

</html>